readthedocs
===========

Dockerfile for evaluation of on-premises readthedocs server and accompanying documentation.

###Build & Run the Docker Image

     $ docker build -t rtd .
     $ docker run --name rtd -ti -w /rtd/checkouts/readthedocs.org -p 8000:8000 rtd bash
     #

###Setup

Broadly speaking, the sequence in this evaluation is based on these [instructions](http://docs.readthedocs.org/en/latest/install.html) in the Read The Docs documentation.  The Dockerfile ensures the necessary software is installed for you.  It also runs the initial Django admin `migrate` command for you to initialise the database schema.  

The rest of the setup must then be done from a shell in the Docker container.

    # ./manage.py createsuperuser
    # ./manage.py collectstatic
    # ./manage.py loaddata test_data
    # ./manage.py runserver 0.0.0.0:8000

When it's all working you should be able to browse to:

    http://192.168.99.100:8000/
    
Login for the first time using the superuser credentials created above in the `createsuperuser` command.  This presents a page asking for verification of the account email address.

But there is no email relay set up yet! Not to worry, just refer to the console logging of the bash shell in the container where you are running the server.  Here will be the equivalent logging output that you would receive in an email if email were set up.  You should see something like this:

```bash
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
Subject: [example.com] Please Confirm Your E-mail Address
From: no-reply@readthedocs.org
To: admin@a4pizza.com
Date: Mon, 14 Mar 2016 14:04:05 -0000
Message-ID: <20160314140405.42.91884@bb4432dd83f6>

Hello from example.com!

You're receiving this e-mail because user admin at example.com has given yours as an e-mail address to connect their account.

To confirm this is correct, go to http://192.168.99.100:8000/accounts/confirm-email/iodpdgfb78ctosoiw0qluymwgbrwfnhf5va9xyy0bbxveuwacf3wuhdxhh8huiii/

Thank you from example.com!
example.com
```

Navigate to the once-only link by copying it into a browser. Click the confirm button on the page to activate the account.

You should then be presented with the login form again.  This time your credentials should log you in directly.  

If you loaded the test data as per the instructions above you will see the dashboard with a number of projects listed.
    
http://192.168.99.100:8000/dashboard/


###Adding a GitHub project

Before you can import a documentation project into your ReadTheDocs server you need to establish a connection to a GitHub account.  To do this, set up a [Developer application](https://github.com/settings/applications/new) on GitHub.  

Use the following values for the GitHub Developer Application.

```
Client ID:     *******************
Client Secret: *******************************************

Homepage URL:  http://192.168.99.100:8000/

Authorization 
callback URL:  http://192.168.99.100:8000/accounts/github/login/callback/
```

You now need to add a corresponding Social Application through the Django admin screen which is accessible through the following URL.

    http://192.168.99.100:8000/admin/   
    
But before we do that we need to add a Site through Django Admin.  Navigate to:
Home > Sites > Add Site and add a site.

    Add Site
    Domain name:    192.168.99.100:8000
    Display Name:   test
    Save
    
Now you have a site, you can add the Social Application.         
    
In the Admin screen select:

>   Social Accounts > Social applications        

Enter the access credentials generated by GitHub:

    Provider:   GitHub
    Name:       test
    Client id:  *********************
    Secret key: *********************
    Key:        test
     
Also make sure that there is a site corresponding to:

    192.168.99.100:8000
    
Ensure that the SITE_ID is correct in the settings.  The actual site ID might be 2 (primary key) because you just created one.  Check the following file.

    #Â vi ./readthedocs/settings/base.py

If all went well, you should now be able to authenticate to GitHub.  Click on Import Project and select the GitHub type.  You will see that you are authenticated as the user for whom you created the GitHub developer application.

When you click to import a project, the ReadTheDocs application will take a while to refresh its list of projects from your GitHub account.

###Adding a Mkdocs documentation project

Select a GitHub project that uses of Mkdocs (one of the formats supported by ReadTheDocs).  Check the box "Edit advanced project options" and hit Next.  Add a  description.  Make sure that the Documentation Type dropdown is set to Mkdocs and then hit Finish.  ReadTheDocs should then set about pulling the project code and building the site documentation.

After a while, you should be presented with the page "Your documentation is ready to use".

Bug!  If you now hit the button "View your documentation" the URL you are sent to is something like:

    http://localhost:8000/docs/mkdocstest/en/stable/
    
Of course, we don't want localhost, we want `192.168.99.100` or something like that for our Docker container.  Clearly we are missing some configuration in the Django set up to tell the Django app what the server is called.  Need to figure this one out still.  Until fixed, just substitute the correct URL in the browser to see your docs.

    http://192.168.99.100:8000/docs/mkdocstest/en/stable/
    
TODO:

* Fix localhost problem
* Make it work with on-prem GitHub
